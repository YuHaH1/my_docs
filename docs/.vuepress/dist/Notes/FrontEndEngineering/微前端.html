<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.61">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/hero.jpg"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css"><title>微前端 | fancy——Blog</title><meta name="description" content="关键功能">
    <link rel="preload" href="/assets/style-e95b4f07.css" as="style"><link rel="stylesheet" href="/assets/style-e95b4f07.css">
    <link rel="modulepreload" href="/assets/app-c7df0862.js"><link rel="modulepreload" href="/assets/framework-f7ec573f.js"><link rel="modulepreload" href="/assets/微前端.html-74ecc39b.js"><link rel="modulepreload" href="/assets/微前端.html-ac517c52.js"><link rel="prefetch" href="/assets/contributing.html-22a7bdc8.js" as="script"><link rel="prefetch" href="/assets/index.html-c2be8bda.js" as="script"><link rel="prefetch" href="/assets/index.html-72dd86c0.js" as="script"><link rel="prefetch" href="/assets/index.html-a998ae2b.js" as="script"><link rel="prefetch" href="/assets/浏览器相关面经.html-9a1ff354.js" as="script"><link rel="prefetch" href="/assets/计算机网络.html-5930550e.js" as="script"><link rel="prefetch" href="/assets/css面经.html-977a937e.js" as="script"><link rel="prefetch" href="/assets/js面经.html-8d08ffc7.js" as="script"><link rel="prefetch" href="/assets/index.html-828920e8.js" as="script"><link rel="prefetch" href="/assets/node面经.html-500ff87e.js" as="script"><link rel="prefetch" href="/assets/操作系统.html-bab6be77.js" as="script"><link rel="prefetch" href="/assets/Vue面经.html-8d38bd0a.js" as="script"><link rel="prefetch" href="/assets/数据结构.html-91020950.js" as="script"><link rel="prefetch" href="/assets/算法.html-e3ca3661.js" as="script"><link rel="prefetch" href="/assets/浏览器必备知识.html-a8382f01.js" as="script"><link rel="prefetch" href="/assets/canvas基础.html-d0b84296.js" as="script"><link rel="prefetch" href="/assets/你不知道的css.html-cb9e9d5d.js" as="script"><link rel="prefetch" href="/assets/docker基础知识.html-16370c91.js" as="script"><link rel="prefetch" href="/assets/英语单词.html-090651ce.js" as="script"><link rel="prefetch" href="/assets/babel.html-19e2ed0b.js" as="script"><link rel="prefetch" href="/assets/CI-CD.html-d4bb7d4e.js" as="script"><link rel="prefetch" href="/assets/flutter.html-9e25da6b.js" as="script"><link rel="prefetch" href="/assets/packageJson文件.html-08bdbad3.js" as="script"><link rel="prefetch" href="/assets/rollup.html-6094f99b.js" as="script"><link rel="prefetch" href="/assets/vite必懂知识.html-7de72106.js" as="script"><link rel="prefetch" href="/assets/Vite插件开发.html-ae5424c3.js" as="script"><link rel="prefetch" href="/assets/webpack必懂知识.html-4b539380.js" as="script"><link rel="prefetch" href="/assets/webpack搭建Vue3ts.html-d2a66d1d.js" as="script"><link rel="prefetch" href="/assets/包管理器的相关知识.html-ef770eca.js" as="script"><link rel="prefetch" href="/assets/单元测试.html-9919e738.js" as="script"><link rel="prefetch" href="/assets/跨端开发.html-355087f6.js" as="script"><link rel="prefetch" href="/assets/项目搭建.html-6093d32c.js" as="script"><link rel="prefetch" href="/assets/鸿蒙.html-bd210189.js" as="script"><link rel="prefetch" href="/assets/Git基础.html-a2980c8c.js" as="script"><link rel="prefetch" href="/assets/js进阶.html-02991cb5.js" as="script"><link rel="prefetch" href="/assets/必会APIs.html-12db5bc6.js" as="script"><link rel="prefetch" href="/assets/设计模式.html-67082624.js" as="script"><link rel="prefetch" href="/assets/linux常用指令.html-96826953.js" as="script"><link rel="prefetch" href="/assets/shell脚本.html-fd88221f.js" as="script"><link rel="prefetch" href="/assets/性能优化.html-10a8de50.js" as="script"><link rel="prefetch" href="/assets/diff.html-83aa66ca.js" as="script"><link rel="prefetch" href="/assets/fiber.html-613e6ec6.js" as="script"><link rel="prefetch" href="/assets/React状态管理.html-97ced59e.js" as="script"><link rel="prefetch" href="/assets/基础.html-7756477b.js" as="script"><link rel="prefetch" href="/assets/正则表达式.html-2064539b.js" as="script"><link rel="prefetch" href="/assets/grammar.html-b372dc3f.js" as="script"><link rel="prefetch" href="/assets/grammar.html-2bb01fd8.js" as="script"><link rel="prefetch" href="/assets/类型体操.html-675b2cd0.js" as="script"><link rel="prefetch" href="/assets/common_apis.html-35b2f21b.js" as="script"><link rel="prefetch" href="/assets/golang.html-46083e67.js" as="script"><link rel="prefetch" href="/assets/Nest.html-fac97f9d.js" as="script"><link rel="prefetch" href="/assets/Nginx.html-35a949b3.js" as="script"><link rel="prefetch" href="/assets/node基础知识.html-e3ec3758.js" as="script"><link rel="prefetch" href="/assets/pm2.html-494b398a.js" as="script"><link rel="prefetch" href="/assets/sequelize.html-0604cb37.js" as="script"><link rel="prefetch" href="/assets/diff.html-3075f372.js" as="script"><link rel="prefetch" href="/assets/Nuxt.html-aa66f85c.js" as="script"><link rel="prefetch" href="/assets/pinia.html-b31a0287.js" as="script"><link rel="prefetch" href="/assets/vue-loader初探.html-ae80b7ef.js" as="script"><link rel="prefetch" href="/assets/Vue3.html-d9d52379.js" as="script"><link rel="prefetch" href="/assets/Vue3异步更新.html-1e3796ce.js" as="script"><link rel="prefetch" href="/assets/vueRouter.html-46771925.js" as="script"><link rel="prefetch" href="/assets/Vue内置组件.html-7e6d676a.js" as="script"><link rel="prefetch" href="/assets/vue版本迭代.html-ece47a24.js" as="script"><link rel="prefetch" href="/assets/Vue生命周期.html-1fa0e50e.js" as="script"><link rel="prefetch" href="/assets/响应式原理.html-f8124466.js" as="script"><link rel="prefetch" href="/assets/编译原理.html-751f2cfa.js" as="script"><link rel="prefetch" href="/assets/Web3.html-54d84db7.js" as="script"><link rel="prefetch" href="/assets/CSS相关问题.html-b42a70f0.js" as="script"><link rel="prefetch" href="/assets/js中遇到的问题.html-c5442ecb.js" as="script"><link rel="prefetch" href="/assets/埋点.html-3718ab8c.js" as="script"><link rel="prefetch" href="/assets/pm2.html-8a67efcb.js" as="script"><link rel="prefetch" href="/assets/项目中得到的问题.html-000cf576.js" as="script"><link rel="prefetch" href="/assets/服务器.html-c5c1c988.js" as="script"><link rel="prefetch" href="/assets/好用的依赖工具包.html-661c0d92.js" as="script"><link rel="prefetch" href="/assets/js实现效果.html-fff25bd3.js" as="script"><link rel="prefetch" href="/assets/Vuepress插件.html-7a5afd36.js" as="script"><link rel="prefetch" href="/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/assets/contributing.html-ba442e82.js" as="script"><link rel="prefetch" href="/assets/index.html-7d0386cd.js" as="script"><link rel="prefetch" href="/assets/index.html-94d0b65c.js" as="script"><link rel="prefetch" href="/assets/index.html-11b99220.js" as="script"><link rel="prefetch" href="/assets/浏览器相关面经.html-f355221a.js" as="script"><link rel="prefetch" href="/assets/计算机网络.html-0e849dba.js" as="script"><link rel="prefetch" href="/assets/css面经.html-5d44c013.js" as="script"><link rel="prefetch" href="/assets/js面经.html-2aa88e22.js" as="script"><link rel="prefetch" href="/assets/index.html-81702ac2.js" as="script"><link rel="prefetch" href="/assets/node面经.html-2a33d7d0.js" as="script"><link rel="prefetch" href="/assets/操作系统.html-f40b8e31.js" as="script"><link rel="prefetch" href="/assets/Vue面经.html-4d3849d4.js" as="script"><link rel="prefetch" href="/assets/数据结构.html-f251afa0.js" as="script"><link rel="prefetch" href="/assets/算法.html-f3d711e4.js" as="script"><link rel="prefetch" href="/assets/浏览器必备知识.html-bbf0e235.js" as="script"><link rel="prefetch" href="/assets/canvas基础.html-52f92012.js" as="script"><link rel="prefetch" href="/assets/你不知道的css.html-715db008.js" as="script"><link rel="prefetch" href="/assets/docker基础知识.html-477bccf8.js" as="script"><link rel="prefetch" href="/assets/英语单词.html-4f77de78.js" as="script"><link rel="prefetch" href="/assets/babel.html-16942d82.js" as="script"><link rel="prefetch" href="/assets/CI-CD.html-555b4dcc.js" as="script"><link rel="prefetch" href="/assets/flutter.html-529b73bb.js" as="script"><link rel="prefetch" href="/assets/packageJson文件.html-11d15d06.js" as="script"><link rel="prefetch" href="/assets/rollup.html-a595b44b.js" as="script"><link rel="prefetch" href="/assets/vite必懂知识.html-f97a5e28.js" as="script"><link rel="prefetch" href="/assets/Vite插件开发.html-ceb0ea8c.js" as="script"><link rel="prefetch" href="/assets/webpack必懂知识.html-d8c1bda9.js" as="script"><link rel="prefetch" href="/assets/webpack搭建Vue3ts.html-0fabafd1.js" as="script"><link rel="prefetch" href="/assets/包管理器的相关知识.html-08ffc5b8.js" as="script"><link rel="prefetch" href="/assets/单元测试.html-8a97cce2.js" as="script"><link rel="prefetch" href="/assets/跨端开发.html-45cb3ad1.js" as="script"><link rel="prefetch" href="/assets/项目搭建.html-a82748aa.js" as="script"><link rel="prefetch" href="/assets/鸿蒙.html-30d8534e.js" as="script"><link rel="prefetch" href="/assets/Git基础.html-b3f065a4.js" as="script"><link rel="prefetch" href="/assets/js进阶.html-d4319520.js" as="script"><link rel="prefetch" href="/assets/必会APIs.html-c731d2f3.js" as="script"><link rel="prefetch" href="/assets/设计模式.html-f8a43ccb.js" as="script"><link rel="prefetch" href="/assets/linux常用指令.html-1d9da641.js" as="script"><link rel="prefetch" href="/assets/shell脚本.html-6aebb3f3.js" as="script"><link rel="prefetch" href="/assets/性能优化.html-9855fde0.js" as="script"><link rel="prefetch" href="/assets/diff.html-814f8aa1.js" as="script"><link rel="prefetch" href="/assets/fiber.html-ab68055a.js" as="script"><link rel="prefetch" href="/assets/React状态管理.html-bded037c.js" as="script"><link rel="prefetch" href="/assets/基础.html-808daa92.js" as="script"><link rel="prefetch" href="/assets/正则表达式.html-e756bf27.js" as="script"><link rel="prefetch" href="/assets/grammar.html-f9877cfd.js" as="script"><link rel="prefetch" href="/assets/grammar.html-92b707f6.js" as="script"><link rel="prefetch" href="/assets/类型体操.html-e68b486a.js" as="script"><link rel="prefetch" href="/assets/common_apis.html-c90cc702.js" as="script"><link rel="prefetch" href="/assets/golang.html-fea25c84.js" as="script"><link rel="prefetch" href="/assets/Nest.html-593360c9.js" as="script"><link rel="prefetch" href="/assets/Nginx.html-f447a18b.js" as="script"><link rel="prefetch" href="/assets/node基础知识.html-8286d90a.js" as="script"><link rel="prefetch" href="/assets/pm2.html-c74b20bb.js" as="script"><link rel="prefetch" href="/assets/sequelize.html-9be1982f.js" as="script"><link rel="prefetch" href="/assets/diff.html-d5e8a104.js" as="script"><link rel="prefetch" href="/assets/Nuxt.html-ae58220b.js" as="script"><link rel="prefetch" href="/assets/pinia.html-1437c3e8.js" as="script"><link rel="prefetch" href="/assets/vue-loader初探.html-1cfc4d9f.js" as="script"><link rel="prefetch" href="/assets/Vue3.html-37a76944.js" as="script"><link rel="prefetch" href="/assets/Vue3异步更新.html-217f74b3.js" as="script"><link rel="prefetch" href="/assets/vueRouter.html-dbcb3ad0.js" as="script"><link rel="prefetch" href="/assets/Vue内置组件.html-27742815.js" as="script"><link rel="prefetch" href="/assets/vue版本迭代.html-f4446088.js" as="script"><link rel="prefetch" href="/assets/Vue生命周期.html-aba3d8c2.js" as="script"><link rel="prefetch" href="/assets/响应式原理.html-f4dedb3f.js" as="script"><link rel="prefetch" href="/assets/编译原理.html-03c81446.js" as="script"><link rel="prefetch" href="/assets/Web3.html-d628e486.js" as="script"><link rel="prefetch" href="/assets/CSS相关问题.html-06830154.js" as="script"><link rel="prefetch" href="/assets/js中遇到的问题.html-5e831821.js" as="script"><link rel="prefetch" href="/assets/埋点.html-1957d5c8.js" as="script"><link rel="prefetch" href="/assets/pm2.html-9f4e74cf.js" as="script"><link rel="prefetch" href="/assets/项目中得到的问题.html-6a5920a9.js" as="script"><link rel="prefetch" href="/assets/服务器.html-8f508db2.js" as="script"><link rel="prefetch" href="/assets/好用的依赖工具包.html-db7cc715.js" as="script"><link rel="prefetch" href="/assets/js实现效果.html-3dc39774.js" as="script"><link rel="prefetch" href="/assets/Vuepress插件.html-77268f44.js" as="script"><link rel="prefetch" href="/assets/404.html-b0ff3419.js" as="script"><link rel="prefetch" href="/assets/giscus-f311b0ba.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/logo.png" alt="fancy——Blog"><span class="site-name can-hide">fancy——Blog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="笔记查询"><span class="title">笔记查询</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="笔记查询"><span class="title">笔记查询</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/Notes/React/基础.md" class="" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Vue/编译原理.md" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Sass/grammar.md" class="" aria-label="Sass"><!--[--><!--]--> Sass <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/TypeScript/类型体操.md" class="" aria-label="TypeScript"><!--[--><!--]--> TypeScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/JavaScript/设计模式.md" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Docker/docker基础知识.md" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Linux/shell脚本.md" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Css/你不知道的css.md" class="" aria-label="Css"><!--[--><!--]--> Css <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Canvas/canvas基础.md" class="" aria-label="Canvas"><!--[--><!--]--> Canvas <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/FrontEndEngineering/鸿蒙.md" class="" aria-label="FrontEndEngineering"><!--[--><!--]--> FrontEndEngineering <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Optimize/性能优化.md" class="" aria-label="Optimize"><!--[--><!--]--> Optimize <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/English/英语单词.md" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Git/Git基础.md" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Browser/浏览器必备知识.md" class="" aria-label="Browser"><!--[--><!--]--> Browser <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Algorithms/算法.md" class="" aria-label="Algorithms"><!--[--><!--]--> Algorithms <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Server/sequelize.md" class="" aria-label="Server"><!--[--><!--]--> Server <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Web3/Web3.md" class="" aria-label="Web3"><!--[--><!--]--> Web3 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Reg/正则表达式.md" class="" aria-label="Reg"><!--[--><!--]--> Reg <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="问题记录"><span class="title">问题记录</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="问题记录"><span class="title">问题记录</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/Problems/Server/服务器.md" class="" aria-label="Server"><!--[--><!--]--> Server <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Problems/JavaScript/埋点.md" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Problems/Project/项目中得到的问题.md" class="" aria-label="Project"><!--[--><!--]--> Project <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Problems/Node/pm2.md" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Problems/Css/CSS相关问题.md" class="" aria-label="Css"><!--[--><!--]--> Css <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="面经"><span class="title">面经</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="面经"><span class="title">面经</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/Interview/Node/node面经.md" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/ComputerNetwork/计算机网络.md" class="" aria-label="ComputerNetwork"><!--[--><!--]--> ComputerNetwork <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/JavaScript/README.md" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/Css/css面经.md" class="" aria-label="Css"><!--[--><!--]--> Css <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/Vue/Vue面经.md" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/Browser/浏览器相关面经.md" class="" aria-label="Browser"><!--[--><!--]--> Browser <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/OS/操作系统.md" class="" aria-label="OS"><!--[--><!--]--> OS <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="不错的工具"><span class="title">不错的工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="不错的工具"><span class="title">不错的工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/Utils/Vuepress/Vuepress插件.md" class="" aria-label="Vuepress"><!--[--><!--]--> Vuepress <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Utils/NodeDependency/好用的依赖工具包.md" class="" aria-label="NodeDependency"><!--[--><!--]--> NodeDependency <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Utils/SpecialEffects/js实现效果.md" class="" aria-label="SpecialEffects"><!--[--><!--]--> SpecialEffects <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="个人信息"><span class="title">个人信息</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="个人信息"><span class="title">个人信息</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/YuHaH1" rel="noopener noreferrer" target="_blank" aria-label="github"><!--[--><!--]--> github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://blog.csdn.net/m0_47195133?type=blog" rel="noopener noreferrer" target="_blank" aria-label="CSDN"><!--[--><!--]--> CSDN <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索关键词" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="笔记查询"><span class="title">笔记查询</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="笔记查询"><span class="title">笔记查询</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/Notes/React/基础.md" class="" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Vue/编译原理.md" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Sass/grammar.md" class="" aria-label="Sass"><!--[--><!--]--> Sass <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/TypeScript/类型体操.md" class="" aria-label="TypeScript"><!--[--><!--]--> TypeScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/JavaScript/设计模式.md" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Docker/docker基础知识.md" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Linux/shell脚本.md" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Css/你不知道的css.md" class="" aria-label="Css"><!--[--><!--]--> Css <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Canvas/canvas基础.md" class="" aria-label="Canvas"><!--[--><!--]--> Canvas <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/FrontEndEngineering/鸿蒙.md" class="" aria-label="FrontEndEngineering"><!--[--><!--]--> FrontEndEngineering <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Optimize/性能优化.md" class="" aria-label="Optimize"><!--[--><!--]--> Optimize <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/English/英语单词.md" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Git/Git基础.md" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Browser/浏览器必备知识.md" class="" aria-label="Browser"><!--[--><!--]--> Browser <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Algorithms/算法.md" class="" aria-label="Algorithms"><!--[--><!--]--> Algorithms <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Server/sequelize.md" class="" aria-label="Server"><!--[--><!--]--> Server <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Web3/Web3.md" class="" aria-label="Web3"><!--[--><!--]--> Web3 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Notes/Reg/正则表达式.md" class="" aria-label="Reg"><!--[--><!--]--> Reg <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="问题记录"><span class="title">问题记录</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="问题记录"><span class="title">问题记录</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/Problems/Server/服务器.md" class="" aria-label="Server"><!--[--><!--]--> Server <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Problems/JavaScript/埋点.md" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Problems/Project/项目中得到的问题.md" class="" aria-label="Project"><!--[--><!--]--> Project <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Problems/Node/pm2.md" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Problems/Css/CSS相关问题.md" class="" aria-label="Css"><!--[--><!--]--> Css <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="面经"><span class="title">面经</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="面经"><span class="title">面经</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/Interview/Node/node面经.md" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/ComputerNetwork/计算机网络.md" class="" aria-label="ComputerNetwork"><!--[--><!--]--> ComputerNetwork <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/JavaScript/README.md" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/Css/css面经.md" class="" aria-label="Css"><!--[--><!--]--> Css <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/Vue/Vue面经.md" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/Browser/浏览器相关面经.md" class="" aria-label="Browser"><!--[--><!--]--> Browser <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Interview/OS/操作系统.md" class="" aria-label="OS"><!--[--><!--]--> OS <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="不错的工具"><span class="title">不错的工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="不错的工具"><span class="title">不错的工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/Utils/Vuepress/Vuepress插件.md" class="" aria-label="Vuepress"><!--[--><!--]--> Vuepress <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Utils/NodeDependency/好用的依赖工具包.md" class="" aria-label="NodeDependency"><!--[--><!--]--> NodeDependency <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Utils/SpecialEffects/js实现效果.md" class="" aria-label="SpecialEffects"><!--[--><!--]--> SpecialEffects <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="个人信息"><span class="title">个人信息</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="个人信息"><span class="title">个人信息</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/YuHaH1" rel="noopener noreferrer" target="_blank" aria-label="github"><!--[--><!--]--> github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://blog.csdn.net/m0_47195133?type=blog" rel="noopener noreferrer" target="_blank" aria-label="CSDN"><!--[--><!--]--> CSDN <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active collapsible">FrontEndEngineering <span class="down arrow"></span></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/Notes/FrontEndEngineering/webpack%E6%90%AD%E5%BB%BAVue3ts.html" class="sidebar-item" aria-label="Webpack搭建Vue3ts"><!--[--><!--]--> Webpack搭建Vue3ts <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/vite%E5%BF%85%E6%87%82%E7%9F%A5%E8%AF%86.html" class="sidebar-item" aria-label="vite必懂知识"><!--[--><!--]--> vite必懂知识 <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/webpack%E5%BF%85%E6%87%82%E7%9F%A5%E8%AF%86.html" class="sidebar-item" aria-label="webpack必懂知识"><!--[--><!--]--> webpack必懂知识 <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/Vite%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91.html" class="sidebar-item" aria-label="Vite插件开发"><!--[--><!--]--> Vite插件开发 <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/packageJson%E6%96%87%E4%BB%B6.html" class="sidebar-item" aria-label="packageJson文件"><!--[--><!--]--> packageJson文件 <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8%E7%9A%84%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86.html" class="sidebar-item" aria-label="包管理器的相关知识"><!--[--><!--]--> 包管理器的相关知识 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="微前端"><!--[--><!--]--> 微前端 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#什么是微前端" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么是微前端"><!--[--><!--]--> 什么是微前端 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#微前端的技术方案" class="router-link-active router-link-exact-active sidebar-item" aria-label="微前端的技术方案"><!--[--><!--]--> 微前端的技术方案 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#iframe" class="router-link-active router-link-exact-active sidebar-item" aria-label="iframe"><!--[--><!--]--> iframe <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#spa" class="router-link-active router-link-exact-active sidebar-item" aria-label="SPA"><!--[--><!--]--> SPA <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#_1-微前端解决了什么问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.微前端解决了什么问题？"><!--[--><!--]--> 1.微前端解决了什么问题？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#_2-js沙盒" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.JS沙盒"><!--[--><!--]--> 2.JS沙盒 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#_2-1、快照沙箱" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.1、快照沙箱"><!--[--><!--]--> 2.1、快照沙箱 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#_2-2、代理沙箱" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2、代理沙箱"><!--[--><!--]--> 2.2、代理沙箱 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#_2-3、多应用代理沙箱" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3、多应用代理沙箱"><!--[--><!--]--> 2.3、多应用代理沙箱 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#_3-样式隔离" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.样式隔离"><!--[--><!--]--> 3.样式隔离 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#qiankun使用" class="router-link-active router-link-exact-active sidebar-item" aria-label="qiankun使用"><!--[--><!--]--> qiankun使用 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#在主应用中注册微应用" class="router-link-active router-link-exact-active sidebar-item" aria-label="在主应用中注册微应用"><!--[--><!--]--> 在主应用中注册微应用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#微应用配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="微应用配置"><!--[--><!--]--> 微应用配置 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#无界" class="router-link-active router-link-exact-active sidebar-item" aria-label="无界"><!--[--><!--]--> 无界 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#wujie实现原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="wujie实现原理"><!--[--><!--]--> wujie实现原理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#通信方式" class="router-link-active router-link-exact-active sidebar-item" aria-label="通信方式"><!--[--><!--]--> 通信方式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#源码" class="router-link-active router-link-exact-active sidebar-item" aria-label="源码"><!--[--><!--]--> 源码 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#模块联邦module-federation" class="router-link-active router-link-exact-active sidebar-item" aria-label="模块联邦Module Federation"><!--[--><!--]--> 模块联邦Module Federation <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#modulefederationplugin-high-level" class="router-link-active router-link-exact-active sidebar-item" aria-label="ModuleFederationPlugin (high level)"><!--[--><!--]--> ModuleFederationPlugin (high level) <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Notes/FrontEndEngineering/%E5%BE%AE%E5%89%8D%E7%AB%AF.html#基本概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="基本概念"><!--[--><!--]--> 基本概念 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a href="/Notes/FrontEndEngineering/%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA.html" class="sidebar-item" aria-label="项目初始化"><!--[--><!--]--> 项目初始化 <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/rollup.html" class="sidebar-item" aria-label="rollup"><!--[--><!--]--> rollup <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.html" class="sidebar-item" aria-label="单元测试"><!--[--><!--]--> 单元测试 <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/%E8%B7%A8%E7%AB%AF%E5%BC%80%E5%8F%91.html" class="sidebar-item" aria-label="跨端开发"><!--[--><!--]--> 跨端开发 <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/flutter.html" class="sidebar-item" aria-label="flutter"><!--[--><!--]--> flutter <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/%E9%B8%BF%E8%92%99.html" class="sidebar-item" aria-label="鸿蒙"><!--[--><!--]--> 鸿蒙 <!--[--><!--]--></a><!----></li><li><a href="/Notes/FrontEndEngineering/babel.html" class="sidebar-item" aria-label="babel"><!--[--><!--]--> babel <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="微前端" tabindex="-1"><a class="header-anchor" href="#微前端" aria-hidden="true">#</a> 微前端</h1><h2 id="什么是微前端" tabindex="-1"><a class="header-anchor" href="#什么是微前端" aria-hidden="true">#</a> 什么是微前端</h2><p>微前端是一种多个团队通过独立发布功能的方式来共同构建现代化 web 应用的技术手段及方法策略。通俗来说，<strong>就是在一个<code>web</code>应用中可以独立的运行另一个<code>web</code>应用</strong></p><p>摘自wujie官网的一段话。为前端需要具备什么能力？</p><ul><li><p><strong>子应用的加载和卸载能力</strong></p><p>页面需要从一个子应用切换到另一个子应用，框架必须具备加载、渲染、切换的能力</p></li><li><p><strong>子应用独立运行的能力</strong></p><p>子应用运行会污染全局的 window 对象，样式会污染其他应用，必须有效的隔离起来</p></li><li><p><strong>子应用路由状态保持能力</strong></p><p>激活子应用后，浏览器刷新、前进、后退子应用的路由都应该可以正常工作</p></li><li><p><strong>应用间通信的能力</strong></p><p>应用间可以方便、<strong>快捷的通信</strong>。（通信的三种方式①事件订阅例如$bus，②全局window上的属性读取和写入，③框架提供props的接口）</p></li></ul><h2 id="微前端的技术方案" tabindex="-1"><a class="header-anchor" href="#微前端的技术方案" aria-hidden="true">#</a> 微前端的技术方案</h2><h3 id="iframe" tabindex="-1"><a class="header-anchor" href="#iframe" aria-hidden="true">#</a> iframe</h3><p><strong>优点</strong></p><ul><li>非常简单，使用没有任何心智负担</li><li><code>web</code>应用隔离的非常完美，无论是<code>js</code>、<code>css</code>、<code>dom</code>都完全隔离开来</li></ul><p><strong>iframe的缺点：</strong></p><ol><li>url 不同步。浏览器刷新 iframe url 状态丢失、后退前进按钮无法使用。</li><li>UI 不同步，DOM 结构不共享。想象一下屏幕右下角 1/4 的 iframe 里来一个带遮罩层的弹框，同时我们要求这个弹框要浏览器居中显示，还要浏览器 resize 时自动居中。</li><li>全局上下文完全隔离，内存变量不共享。iframe 内外系统的通信、数据同步等需求，主应用的 cookie 要透传到根域名都不同的子应用中实现免登效果。</li><li>慢。每次子应用进入都是一次浏览器上下文重建、资源重新加载的过程。</li></ol><h3 id="spa" tabindex="-1"><a class="header-anchor" href="#spa" aria-hidden="true">#</a> SPA</h3><p><a href="https://zh-hans.single-spa.js.org/docs/getting-started-overview" target="_blank" rel="noopener noreferrer">single-spa<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>主要实现思路：</p><ul><li>预先注册子应用(激活路由、子应用资源、生命周期函数)</li><li>监听路由的变化，匹配到了激活的路由则加载子应用资源，顺序调用生命周期函数并最终渲染到容器</li></ul><p><strong>优点</strong></p><ul><li>监听路由自动的加载、卸载当前路由对应的子应用</li><li>完备的沙箱方案，<code>js</code>沙箱做了<code>SnapshotSandbox</code>、<code>LegacySandbox</code>、<code>ProxySandbox</code>三套渐进增强方案，<code>css</code>沙箱做了两套<code>strictStyleIsolation</code>、<code>experimentalStyleIsolation</code>两套适用不同场景的方案</li><li>路由保持，浏览器刷新、前进、后退，都可以作用到子应用</li><li>应用间通信简单，全局注入</li></ul><p>缺点</p><ul><li>基于路由匹配，无法同时<strong>激活多个子应用，也不支持子应用保活</strong>。</li><li>改造成本较大，从 <code>webpack</code>、代码、路由等等都要做一系列的适配</li><li><code>css</code> 沙箱无法绝对的隔离，<code>js</code> 沙箱在某些场景下执行性能下降严重</li><li><strong>无法支持 <code>vite</code> 等 <code>ESM</code> 脚本运行</strong></li></ul><h2 id="_1-微前端解决了什么问题" tabindex="-1"><a class="header-anchor" href="#_1-微前端解决了什么问题" aria-hidden="true">#</a> 1.微前端解决了什么问题？</h2><p>1.随着应用程序的规模不断增大，代码库也会变得越来越复杂，导致开发人员难以理解和维护。</p><p>2.在传统的前端应用程序中，所有的开发人员都必须使用相同的技术栈和框架进行开发，这限制了开发人员的选择和自由度。</p><p>微前端的优点</p><p>1.**大型应用程序的可维护性：**微前端将应用程序拆分成小块，每个小块都有自己的职责和功能，使得代码库更加清晰和易于维护。</p><p>2.<strong>团队协作便利性</strong>：微前端允许每个小块使用不同的技术栈和框架，使得开发人员可以选择最适合自己的工具和技术进行开发，从而提高团队协作的效率和质量。</p><p>3.**可独立部署和扩展：**微前端允许每个小块独立地进行部署和扩展，这样可以避免整个应用程序的停机时间和风险，并且可以更加灵活地扩展应用程序的功能。此外，微前端还可以让不同的小块在不同的服务器上运行，从而提高应用程序的性能和可用性。</p><p>4.<strong>适应不同的场景和需求</strong>：微前端可以将应用程序拆分成小块，每个小块都可以被设计为不同的场景和需求。</p><p>下面两个问题是微前端需要考虑的问题。</p><p>1.JS沙箱问题</p><p>2.样式隔离问题</p><h2 id="_2-js沙盒" tabindex="-1"><a class="header-anchor" href="#_2-js沙盒" aria-hidden="true">#</a> 2.JS沙盒</h2><p>JS沙盒是一种安全的JavaScript执行环境，可以限制脚本的访问权限，从而保护宿主环境免受恶意脚本的攻击。在微前端中，我们需要给子应用提供沙盒环境，<strong>防止应用之间互相污染以及污染全局变量。</strong></p><p><strong>with() + new Function(code) + Proxy</strong></p><p><code>with</code> 语法用于改变作用域链，这里用来拦截写访问全局变量时对 window 的查找，如直接访问 <code>Array.from</code> 而不是 <code>window.Array.from</code> 写法时；</p><p><code>new Function</code> 执行 code 作用等同于 eval，但 eval 能访问到当前局部作用域变量，new Function 返回函数不管哪里执行，都只能访问全局作用域，正是我们想要的。</p><p>而 <code>Proxy</code> 提供的是 with 和 new Function 闭包中用到的充当 window 作用域的对象，通过白名单属性限制能访问真正 window 上的部分元素，通过 Proxy 让删除 / 添加全局变量 / api 时不会对真正全局 window 产生影响；</p><p>同时对 document / history / localtion 上各类操作做劫持，比如把 document.body 上插入元素乾坤大挪移、把 history.push 改写再同步到 url、把 localtion path 拦截让子应用只获取内部路由， 等等，这些种种限制组成沙箱环境；</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 简化伪代码示例</span>
window <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token function">pick</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> whiteListProperties<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
document <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>

sandbox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  return function ({ window, location, history, document }, code){
    with(window) {
      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    }
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

<span class="token function">sandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token punctuation">{</span> window<span class="token punctuation">,</span> location<span class="token punctuation">,</span> history<span class="token punctuation">,</span> document <span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1、快照沙箱" tabindex="-1"><a class="header-anchor" href="#_2-1、快照沙箱" aria-hidden="true">#</a> 2.1、快照沙箱</h3><p><strong>把主应用的 <code>window</code> 对象做浅拷贝，将 <code>window</code> 的键值对存成一个 <code>Hash Map</code>。之后无论微应用对 <code>window</code> 做任何改动，当要在恢复环境时，把这个 <code>Hash Map</code> 又应用到 <code>window</code> 上就可以了</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">iter</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token keyword">typeof</span> window<span class="token punctuation">,</span> <span class="token function-variable function">callbackFn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">prop</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// eslint-disable-next-line guard-for-in, no-restricted-syntax</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> prop <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callbackFn</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 基于 diff 方式实现的沙箱，用于不支持 Proxy 的低版本浏览器
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SnapshotSandbox</span> <span class="token keyword">implements</span> <span class="token class-name">SandBox</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">proxy</span><span class="token operator">:</span> WindowProxy<span class="token punctuation">;</span>

  <span class="token literal-property property">name</span><span class="token operator">:</span> string<span class="token punctuation">;</span>

  <span class="token literal-property property">type</span><span class="token operator">:</span> SandBoxType<span class="token punctuation">;</span>

  sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> windowSnapshot<span class="token operator">!</span><span class="token operator">:</span> Window<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token literal-property property">modifyPropsMap</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">name</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> window<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> SandBoxType<span class="token punctuation">.</span>Snapshot<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录当前快照</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>windowSnapshot <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> Window<span class="token punctuation">;</span>
    <span class="token function">iter</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">prop</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>windowSnapshot<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 恢复之前的变更</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifyPropsMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">p</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modifyPropsMap<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">inactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modifyPropsMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">iter</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">prop</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>windowSnapshot<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 记录变更，恢复环境</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>modifyPropsMap<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
        window<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>windowSnapshot<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;development&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun:sandbox] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> origin window restore...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifyPropsMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>子应用 <code>mount</code> 时</p><ul><li>先把上一次记录的变更 <code>modifyPropsMap</code> 应用到子应用的全局 <code>window</code>，没有则跳过</li><li>浅复制主应用的 <code>window</code> key-value 快照，用于下次恢复全局环境</li></ul><p>子应用 <code>unmount</code> 时</p><ul><li>将当前子应用 <code>window</code> 的 <code>key-value</code> 和 <code>快照</code> 的 <code>key-value</code> 进行 Diff，Diff 出来的结果用于下次恢复微应用环境的依据</li><li>将上次快照的 <code>key-value</code> 拷贝到主应用的 <code>window</code> 上，以此恢复环境</li></ul></div><p><strong>快照沙箱存在的问题</strong>：</p><p>1.会改变全局window的属性，如果同时运行多个微应用，多个应用同时改写window上的属性，势必会出现状态混乱，<strong>支持多应用的代理沙箱</strong>可以很好的解决这个问题；</p><p>2.会通过<code>for(prop in window){}</code>的方式来遍历window上的所有属性，window属性众多，这其实是一件很耗费性能的事情。关于这个问题<strong>支持单应用的代理沙箱</strong>和<strong>支持多应用的代理沙箱</strong>都可以规避。</p><h3 id="_2-2、代理沙箱" tabindex="-1"><a class="header-anchor" href="#_2-2、代理沙箱" aria-hidden="true">#</a> 2.2、代理沙箱</h3><p>实现原理：</p><ol><li>用<code>fakewindow</code>做一个代理，当写入某个属性值时判断window身上是否存在该属性，如果不存在则将该属性和值放入<code>addedmap</code>中如果存在也就意味着客户在做修改，就将该属性原始值放入<code>modifiedmap</code>中，将修改后的值放入<code>currentMap</code>中</li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Legacy</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 沙箱期间新增的全局变量</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>addedPropsMapInSandbox <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 沙箱期间更新的全局变量</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modifiedPropsOriginalValueMapInSandbox <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 持续记录更新的(新增和修改的)全局变量的 map，用于在任意时刻做 snapshot</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentUpdatedPropsValueMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> rawWindow <span class="token operator">=</span> window<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fakeWindow <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>fakeWindow<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果是激活状态</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 判断当前window上存不存在该属性</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rawWindow<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 记录新增值</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>addedPropsMapInSandbox<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifiedPropsOriginalValueMapInSandbox<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 记录更新值的初始值</span>
            <span class="token keyword">const</span> originValue <span class="token operator">=</span> rawWindow<span class="token punctuation">[</span>prop<span class="token punctuation">]</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>modifiedPropsOriginalValueMapInSandbox<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> originValue<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 纪录此次修改的属性</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>currentUpdatedPropsValueMap<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token comment">// 将设置的属性和值赋给了当前window，还是污染了全局window变量</span>
          rawWindow<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rawWindow<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> proxy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 还原上次修改的值</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentUpdatedPropsValueMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentUpdatedPropsValueMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">inactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将更新值的初始值还原给window</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modifiedPropsOriginalValueMapInSandbox<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modifiedPropsOriginalValueMapInSandbox<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将新增的值删掉</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addedPropsMapInSandbox<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> window<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过三个变量来记住沙箱激活后window发生变化过的所有属性，这样在后续的状态还原时候就不再需要遍历window的所有属性来进行对比，提升了程序运行的性能。但是这仍然改变不了这种机制仍然污染了window的状态的事实，因此也就无法承担起同时支持多个微应用运行的任务。</p><h3 id="_2-3、多应用代理沙箱" tabindex="-1"><a class="header-anchor" href="#_2-3、多应用代理沙箱" aria-hidden="true">#</a> 2.3、多应用代理沙箱</h3><p><strong>不会污染全局window，支持多个子应用同时加载。</strong></p><p>激活沙箱后，每次对<code>window</code>取值的时候，先从自己沙箱环境的<code>fakeWindow</code>里面找，如果不存在，就从<code>rawWindow</code>(外部的<code>window</code>)里去找；当对沙箱内部的<code>window</code>对象赋值的时候，会直接操作<code>fakeWindow</code>，而不会影响到<code>rawWindow</code>。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>
<span class="token doc-comment comment">/**
 * 基于 Proxy 实现的沙箱
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ProxySandbox</span> <span class="token keyword">implements</span> <span class="token class-name">SandBox</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/** window 值变更记录 */</span>
  <span class="token keyword">private</span> updatedValueSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>PropertyKey<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token literal-property property">name</span><span class="token operator">:</span> string<span class="token punctuation">;</span>

  <span class="token literal-property property">type</span><span class="token operator">:</span> SandBoxType<span class="token punctuation">;</span>

  <span class="token literal-property property">proxy</span><span class="token operator">:</span> WindowProxy<span class="token punctuation">;</span>

  sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token literal-property property">latestSetProp</span><span class="token operator">:</span> PropertyKey <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning<span class="token punctuation">)</span> activeSandboxCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">inactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;development&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun:sandbox] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> modified global properties restore...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>updatedValueSet<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>activeSandboxCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      variableWhiteList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>proxy<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// @ts-ignore</span>
          <span class="token keyword">delete</span> window<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">name</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> SandBoxType<span class="token punctuation">.</span>Proxy<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> updatedValueSet <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> rawWindow <span class="token operator">=</span> window<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> fakeWindow<span class="token punctuation">,</span> propertiesWithGetter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createFakeWindow</span><span class="token punctuation">(</span>rawWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> descriptorTargetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>PropertyKey<span class="token punctuation">,</span> SymbolTarget<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">hasOwnProperty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">key</span><span class="token operator">:</span> PropertyKey</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fakeWindow<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> rawWindow<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>fakeWindow<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">set</span><span class="token operator">:</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> FakeWindow<span class="token punctuation">,</span> <span class="token literal-property property">p</span><span class="token operator">:</span> PropertyKey<span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">boolean</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// We must kept its description while the property existed in rawWindow before</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rawWindow<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>rawWindow<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> writable<span class="token punctuation">,</span> configurable<span class="token punctuation">,</span> enumerable <span class="token punctuation">}</span> <span class="token operator">=</span> descriptor<span class="token operator">!</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>writable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                configurable<span class="token punctuation">,</span>
                enumerable<span class="token punctuation">,</span>
                writable<span class="token punctuation">,</span>
                value<span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// @ts-ignore</span>
            target<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>variableWhiteList<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// @ts-ignore</span>
            rawWindow<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          updatedValueSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">this</span><span class="token punctuation">.</span>latestSetProp <span class="token operator">=</span> p<span class="token punctuation">;</span>

          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;development&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] Set window.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>p<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> while sandbox destroyed or inactive in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 在 strict-mode 下，Proxy 的 handler.set 返回 false 会抛出 TypeError，在沙箱卸载的情况下应该忽略错误</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token operator">:</span> FakeWindow<span class="token punctuation">,</span> <span class="token literal-property property">p</span><span class="token operator">:</span> PropertyKey<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> Symbol<span class="token punctuation">.</span>unscopables<span class="token punctuation">)</span> <span class="token keyword">return</span> unscopables<span class="token punctuation">;</span>

        <span class="token comment">// avoid who using window.window or window.self to escape the sandbox environment to touch the really window</span>
        <span class="token comment">// see https://github.com/eligrey/FileSaver.js/blob/master/src/FileSaver.js#L13</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token string">&#39;window&#39;</span> <span class="token operator">||</span> p <span class="token operator">===</span> <span class="token string">&#39;self&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          p <span class="token operator">===</span> <span class="token string">&#39;top&#39;</span> <span class="token operator">||</span>
          p <span class="token operator">===</span> <span class="token string">&#39;parent&#39;</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;test&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token string">&#39;mockTop&#39;</span> <span class="token operator">||</span> p <span class="token operator">===</span> <span class="token string">&#39;mockSafariTop&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// if your master app in an iframe context, allow these props escape the sandbox</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>rawWindow <span class="token operator">===</span> rawWindow<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>rawWindow <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// proxy.hasOwnProperty would invoke getter firstly, then its value represented as rawWindow.hasOwnProperty</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token string">&#39;hasOwnProperty&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> hasOwnProperty<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// mark the symbol to document while accessing as document.createElement could know is invoked by which sandbox for dynamic append patcher</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token string">&#39;document&#39;</span> <span class="token operator">||</span> p <span class="token operator">===</span> <span class="token string">&#39;eval&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setCurrentRunningSandboxProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// FIXME if you have any other good ideas</span>
          <span class="token comment">// remove the mark in next tick, thus we can identify whether it in micro app or not</span>
          <span class="token comment">// this approach is just a workaround, it could not cover all complex cases, such as the micro app runs in the same task context with master in some case</span>
          <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCurrentRunningSandboxProxy</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">switch</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">&#39;document&#39;</span><span class="token operator">:</span>
              <span class="token keyword">return</span> document<span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&#39;eval&#39;</span><span class="token operator">:</span>
              <span class="token comment">// eslint-disable-next-line no-eval</span>
              <span class="token keyword">return</span> eval<span class="token punctuation">;</span>
            <span class="token comment">// no default</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// eslint-disable-next-line no-nested-ternary</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> propertiesWithGetter<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token punctuation">(</span>rawWindow <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span>
          <span class="token operator">:</span> p <span class="token keyword">in</span> target
          <span class="token operator">?</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span>
          <span class="token operator">:</span> <span class="token punctuation">(</span>rawWindow <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getTargetValue</span><span class="token punctuation">(</span>rawWindow<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> proxy<span class="token punctuation">;</span>

    activeSandboxCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createFakeWindow</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">global</span><span class="token operator">:</span> Window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// map always has the fastest performance in has check scenario</span>
  <span class="token comment">// see https://jsperf.com/array-indexof-vs-set-has/23</span>
  <span class="token keyword">const</span> propertiesWithGetter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>PropertyKey<span class="token punctuation">,</span> boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fakeWindow <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> FakeWindow<span class="token punctuation">;</span>

  <span class="token comment">/*
   copy the non-configurable property of global to fakeWindow
   see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/getOwnPropertyDescriptor
   &gt; A property cannot be reported as non-configurable, if it does not exists as an own property of the target object or if it exists as a configurable own property of the target object.
   */</span>
  Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">!</span>descriptor<span class="token operator">?.</span>configurable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hasGetter <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token string">&#39;get&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         make top/self/window property configurable and writable, otherwise it will cause TypeError while get trap return.
         see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/get
         &gt; The value reported for a property must be the same as the value of the corresponding target object property if the target object property is a non-writable, non-configurable data property.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          p <span class="token operator">===</span> <span class="token string">&#39;top&#39;</span> <span class="token operator">||</span>
          p <span class="token operator">===</span> <span class="token string">&#39;parent&#39;</span> <span class="token operator">||</span>
          p <span class="token operator">===</span> <span class="token string">&#39;self&#39;</span> <span class="token operator">||</span>
          p <span class="token operator">===</span> <span class="token string">&#39;window&#39;</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;test&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token string">&#39;mockTop&#39;</span> <span class="token operator">||</span> p <span class="token operator">===</span> <span class="token string">&#39;mockSafariTop&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          descriptor<span class="token punctuation">.</span>configurable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token comment">/*
           The descriptor of window.window/window.top/window.self in Safari/FF are accessor descriptors, we need to avoid adding a data descriptor while it was
           Example:
            Safari/FF: Object.getOwnPropertyDescriptor(window, &#39;top&#39;) -&gt; {get: function, set: undefined, enumerable: true, configurable: false}
            Chrome: Object.getOwnPropertyDescriptor(window, &#39;top&#39;) -&gt; {value: Window, writable: false, enumerable: true, configurable: false}
           */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasGetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            descriptor<span class="token punctuation">.</span>writable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasGetter<span class="token punctuation">)</span> propertiesWithGetter<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// freeze the descriptor to avoid being modified by zone.js</span>
        <span class="token comment">// see https://github.com/angular/zone.js/blob/a5fe09b0fac27ac5df1fa746042f96f05ccb6a00/lib/browser/define-property.ts#L71</span>
        <span class="token function">rawObjectDefineProperty</span><span class="token punctuation">(</span>fakeWindow<span class="token punctuation">,</span> p<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    fakeWindow<span class="token punctuation">,</span>
    propertiesWithGetter<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将window的属性复制到各个子应用的window副本(fakeWindow)，子应用里面的环境和外面的环境完全隔离。因为这种模式不直接操作window，所以在激活和卸载时也不需要操作状态池去更新/还原主子应用的环境状态了，同时也支持了统一url下多个子应用的场景。</p><h2 id="_3-样式隔离" tabindex="-1"><a class="header-anchor" href="#_3-样式隔离" aria-hidden="true">#</a> 3.样式隔离</h2><ol><li>利用了 shadow DoM，可以做到css完全隔离，但是有很多问题（1、弹窗由于挂在到document.Body下导致样式失效 2、shadowdom下不能注册字体）。</li><li>类似于Vue的scoped给每一个子应用的css添加前缀</li></ol><h2 id="qiankun使用" tabindex="-1"><a class="header-anchor" href="#qiankun使用" aria-hidden="true">#</a> qiankun使用</h2><p>qiankun 方案是基于 single-spa 的微前端方案。</p><p><strong>优点：</strong></p><ul><li><p>html entry 的方式引入子应用，相比 js entry 极大的降低了应用改造的成本；</p></li><li><p>完备的沙箱方案，js 沙箱做了 SnapshotSandbox、LegacySandbox、ProxySandbox 三套渐进增强方案，css 沙箱做了 strictStyleIsolation、experimentalStyleIsolation 两套适用不同场景的方案；</p></li><li><p>做了静态资源预加载能力；</p></li></ul><p><strong>缺点：</strong></p><ul><li><p>适配成本比较高，工程化、生命周期、静态资源路径、路由等都要做一系列的适配工作；</p></li><li><p>css 沙箱采用严格隔离会有各种问题，js 沙箱在某些场景下执行性能下降严重；</p></li><li><p>无法同时激活多个子应用，也不支持子应用保活；</p></li><li><p>无法支持 vite 等 esmodule 脚本运行；</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">pnpm</span> <span class="token function">add</span> qiankun <span class="token parameter variable">-S</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="在主应用中注册微应用" tabindex="-1"><a class="header-anchor" href="#在主应用中注册微应用" aria-hidden="true">#</a> 在主应用中注册微应用</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> registerMicroApps<span class="token punctuation">,</span> start <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;qiankun&#39;</span><span class="token punctuation">;</span>

<span class="token function">registerMicroApps</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;react app&#39;</span><span class="token punctuation">,</span> <span class="token comment">// app name registered</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&#39;//localhost:7100&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">container</span><span class="token operator">:</span> <span class="token string">&#39;#yourContainer&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">activeRule</span><span class="token operator">:</span> <span class="token string">&#39;/yourActiveRule&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;vue app&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">scripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;//localhost:7100/main.js&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">container</span><span class="token operator">:</span> <span class="token string">&#39;#yourContainer2&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">activeRule</span><span class="token operator">:</span> <span class="token string">&#39;/yourActiveRule2&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="微应用配置" tabindex="-1"><a class="header-anchor" href="#微应用配置" aria-hidden="true">#</a> 微应用配置</h3><p>微应用分为有 <code>webpack</code> 构建和无 <code>webpack</code> 构建项目，有 <code>webpack</code> 的微应用（主要是指 Vue、React、Angular）需要做的事情有：</p><ol><li>新增 <code>public-path.js</code> 文件，用于修改运行时的 <code>publicPath</code>。<a href="https://webpack.docschina.org/guides/public-path/#on-the-fly" target="_blank" rel="noopener noreferrer">什么是运行时的 publicPath ？<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li></ol><p>注意：运行时的 publicPath 和构建时的 publicPath 是不同的，两者不能等价替代。</p><ol><li>微应用建议使用 <code>history</code> 模式的路由，需要设置路由 <code>base</code>，值和它的 <code>activeRule</code> 是一样的。</li><li>在入口文件最顶部引入 <code>public-path.js</code>，修改并导出三个生命周期函数。</li><li>修改 <code>webpack</code> 打包，允许开发环境跨域和 <code>umd</code> 打包。</li></ol><p>主要的修改就是以上四个，可能会根据项目的不同情况而改变。例如，你的项目是 <code>index.html</code> 和其他的所有文件分开部署的，说明你们已经将构建时的 <code>publicPath</code> 设置为了完整路径，则不用修改运行时的 <code>publicPath</code> （第一步操作可省）。</p><p>无 <code>webpack</code> 构建的微应用直接将 <code>lifecycles</code> 挂载到 <code>window</code> 上即可。</p><p>微应用需要在自己的入口 js (通常就是你配置的 webpack 的 entry js) 导出 <code>bootstrap</code>、<code>mount</code>、<code>unmount</code> 三个生命周期钩子，以供主应用在适当的时机调用。</p><p>以 <code>vue-cli 3+</code> 生成的 <code>vue 2.x</code> 项目为例，<code>vue 3</code> 版本等稳定后再补充。</p><ol><li><p>在 <code>src</code> 目录新增 <code>public-path.js</code>：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  __webpack_public_path__ <span class="token operator">=</span> window<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>入口文件 <code>main.js</code> 修改，为了避免根 id <code>#app</code> 与其他的 DOM 冲突，需要限制查找范围。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token string">&#39;./public-path&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">&#39;vue-router&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&#39;./App.vue&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">&#39;./router&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">&#39;./store&#39;</span><span class="token punctuation">;</span>


Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>productionTip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>


<span class="token keyword">let</span> router <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> container <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
  router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">base</span><span class="token operator">:</span> window<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__ <span class="token operator">?</span> <span class="token string">&#39;/app-vue/&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;history&#39;</span><span class="token punctuation">,</span>
    routes<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    router<span class="token punctuation">,</span>
    store<span class="token punctuation">,</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>container <span class="token operator">?</span> container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 独立运行时</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;[vue] vue app bootstraped&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;[vue] props from main framework&#39;</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  instance<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  router <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>打包配置修改（<code>vue.config.js</code>）：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./package&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&#39;Access-Control-Allow-Origin&#39;</span><span class="token operator">:</span> <span class="token string">&#39;*&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configureWebpack</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-[name]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span> <span class="token string">&#39;umd&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 把微应用打包成 umd 库格式</span>
      <span class="token literal-property property">jsonpFunction</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpackJsonp_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// webpack 5 需要把 jsonpFunction 替换成 chunkLoadingGlobal</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h4 id="微应用打包配置" tabindex="-1"><a class="header-anchor" href="#微应用打包配置" aria-hidden="true">#</a> 微应用打包配置</h4><p>webpack v5:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> packageName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./package.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-[name]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span> <span class="token string">&#39;umd&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">chunkLoadingGlobal</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpackJsonp_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>webpack v4:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> packageName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./package.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-[name]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span> <span class="token string">&#39;umd&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">jsonpFunction</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpackJsonp_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="无界" tabindex="-1"><a class="header-anchor" href="#无界" aria-hidden="true">#</a> 无界</h2><p><strong>wujie优点：</strong></p><ul><li><p><strong>多应用同时激活在线</strong></p><p>框架具备同时激活多应用，并保持这些应用路由同步的能力</p></li><li><p><strong>组件式的使用方式</strong></p><p>无需注册，更无需路由适配，在组件内使用，跟随组件装载、卸载</p></li><li><p><strong>应用级别的 keep-alive</strong></p><p>子应用开启<a href="https://wujie-micro.github.io/doc/api/startApp.html#alive" target="_blank" rel="noopener noreferrer">保活模式<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>后，应用发生切换时整个子应用的状态可以保存下来不丢失，结合<a href="https://wujie-micro.github.io/doc/api/preloadApp.html#exec" target="_blank" rel="noopener noreferrer">预执行模式<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>可以获得类似<code>ssr</code>的打开体验</p></li><li><p><strong>纯净无污染</strong></p><ul><li>无界利用<code>iframe</code>和<code>webcomponent</code>来搭建天然的<code>js</code>隔离沙箱和<code>css</code>隔离沙箱</li><li>利用<code>iframe</code>的<code>history</code>和主应用的<code>history</code>在同一个<a href="https://html.spec.whatwg.org/multipage/browsers.html#top-level-browsing-context" target="_blank" rel="noopener noreferrer">top-level browsing context<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>来搭建天然的路由同步机制</li><li>副作用局限在沙箱内部，子应用切换无需任何清理工作，没有额外的切换成本</li></ul></li><li><p><strong>性能和体积兼具</strong></p><ul><li>子应用执行性能和原生一致，子应用实例<code>instance</code>运行在<code>iframe</code>的<code>window</code>上下文中，避免<code>with(proxyWindow){code}</code>这样指定代码执行上下文导致的性能下降，但是多了实例化<code>iframe</code>的一次性的开销，可以通过 <a href="https://wujie-micro.github.io/doc/api/preloadApp.html" target="_blank" rel="noopener noreferrer">preload<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 提前实例化</li><li>体积比较轻量，借助<code>iframe</code>和<code>webcomponent</code>来实现沙箱，有效的减小了代码量</li></ul></li><li><p><strong>开箱即用</strong></p><p>不管是样式的兼容、路由的处理、弹窗的处理、热更新的加载，子应用完成接入即可开箱即用无需额外处理，应用<a href="https://wujie-micro.github.io/doc/guide/start.html#%E5%AD%90%E5%BA%94%E7%94%A8%E6%94%B9%E9%80%A0" target="_blank" rel="noopener noreferrer">接入成本<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>也极低</p></li></ul><p><strong>缺点：</strong></p><ul><li><p>隔离js使用一个空的iframe进行隔离</p></li><li><p>子应用axios需要自行适配</p></li><li><p>iframe沙箱的src设置了主应用的host，初始化iframe的时候需要等待iframe的location.orign从&#39;about:blank&#39;初始化为主应用的host，这个采用的计时器去等待的不是很悠亚。</p></li></ul><p><a href="https://wujie-micro.github.io/doc/guide/start.html" target="_blank" rel="noopener noreferrer">文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>如果是Vue3作为基座，安装<code>pnpm i wujie-vue3 -S </code>,react就执行<code>pnpm i wujie-react -S</code></p><p>然后在main.js中注册</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token string">&#39;./style.css&#39;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&#39;./App.vue&#39;</span>
<span class="token keyword">import</span> WujieVue <span class="token keyword">from</span> <span class="token string">&#39;wujie-vue3&#39;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
    
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>WujieVue<span class="token punctuation">)</span>    
    
app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span>

<span class="token operator">&lt;</span>WujieVue
  width<span class="token operator">=</span><span class="token string">&quot;100%&quot;</span>
  height<span class="token operator">=</span><span class="token string">&quot;100%&quot;</span>
  name<span class="token operator">=</span><span class="token string">&quot;xxx&quot;</span> <span class="token comment">//必传子应用的唯一id</span>
  <span class="token operator">:</span>url<span class="token operator">=</span><span class="token string">&quot;xxx&quot;</span><span class="token comment">//必传子应用的url</span>
  <span class="token operator">:</span>sync<span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
  <span class="token operator">:</span>fetch<span class="token operator">=</span><span class="token string">&quot;fetch&quot;</span>
  <span class="token operator">:</span>props<span class="token operator">=</span><span class="token string">&quot;props&quot;</span>
  <span class="token operator">:</span>beforeLoad<span class="token operator">=</span><span class="token string">&quot;beforeLoad&quot;</span>
  <span class="token operator">:</span>beforeMount<span class="token operator">=</span><span class="token string">&quot;beforeMount&quot;</span>
  <span class="token operator">:</span>afterMount<span class="token operator">=</span><span class="token string">&quot;afterMount&quot;</span>
  <span class="token operator">:</span>beforeUnmount<span class="token operator">=</span><span class="token string">&quot;beforeUnmount&quot;</span>
  <span class="token operator">:</span>afterUnmount<span class="token operator">=</span><span class="token string">&quot;afterUnmount&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>WujieVue<span class="token operator">&gt;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="wujie实现原理" tabindex="-1"><a class="header-anchor" href="#wujie实现原理" aria-hidden="true">#</a> wujie实现原理</h3><p>①js方面wujie将子应用的js代码注入到主应用的iframe中运行</p><p><strong>优点</strong></p><ul><li><p><strong>组件方式来使用微前端</strong></p><p>不用注册，不用改造路由，直接使用无界组件，化繁为简</p></li><li><p><strong>一个页面可以同时激活多个子应用</strong></p><p>子应用采用 iframe 的路由，不用关心路由占用的问题</p></li><li><p><strong>天然 js 沙箱，不会污染主应用环境</strong></p><p>不用修改主应用<code>window</code>任何属性，只在<code>iframe</code>内部进行修改</p></li><li><p><strong>应用切换没有清理成本</strong></p><p>由于不污染主应用，子应用销毁也无需做任何清理工作</p></li></ul><p>②html上wujie使用<code>webcomponent</code>将子应用的html结构渲染在里面，并通过代理iframe的document到webcomponent实现两者关联。</p><p>③应用保活原理。当子应用发生切换，<code>iframe</code>保留下来，子应用的容器可能销毁，但<code>webcomponent</code>依然可以选择保留，这样等应用切换回来将<code>webcomponent</code>再挂载回容器上，子应用可以获得类似<code>vue</code>的<code>keep-alive</code>的能力.</p><p><strong>优点</strong></p><ul><li><p><strong>天然 css 沙箱</strong></p><p>直接物理隔离，样式隔离子应用不用做任何修改</p></li><li><p><strong>天然适配弹窗问题</strong></p><p><code>document.body</code>的<code>appendChild</code>或者<code>insertBefore</code>会代理直接插入到<code>webcomponent</code>，子应用不用做任何改造</p></li><li><p><strong>子应用保活</strong></p><p>子应用保留<code>iframe</code>和<code>webcomponent</code>，应用内部的<code>state</code>不会丢失</p></li><li><p><strong>完整的 DOM 结构</strong></p><p><code>webcomponent</code>保留了子应用完整的<code>html</code>结构，样式和结构完全对应，子应用不用做任何修改</p></li></ul><p>④css利用shadowDOM隔离CSS</p><h3 id="通信方式" tabindex="-1"><a class="header-anchor" href="#通信方式" aria-hidden="true">#</a> 通信方式</h3><p>承载子应用的<code>iframe</code>和主应用是同域的，所以主、子应用天然就可以很好的进行通信，在无界我们提供三种通信方式</p><ul><li><strong>props 注入机制</strong></li></ul><p>子应用通过<code>$wujie.props</code>可以轻松拿到主应用注入的数据</p><ul><li><strong>window.parent 通信机制</strong></li></ul><p>子应用<code>iframe</code>沙箱和主应用同源，子应用可以直接通过<code>window.parent</code>和主应用通信</p><ul><li><strong>去中心化的通信机制</strong></li></ul><p>无界提供了<code>EventBus</code>实例，注入到主应用和子应用，所有的应用可以去中心化的进行通信</p><h3 id="源码" tabindex="-1"><a class="header-anchor" href="#源码" aria-hidden="true">#</a> 源码</h3><h4 id="学前知识" tabindex="-1"><a class="header-anchor" href="#学前知识" aria-hidden="true">#</a> 学前知识</h4><h4 id="base标签" tabindex="-1"><a class="header-anchor" href="#base标签" aria-hidden="true">#</a> base标签</h4><p><strong>HTML <base> 元素</strong> 指定用于一个文档中包含的所有相对 URL 的根 URL。一份中只能有一个 <base> 元素。</p><p>一个文档的基本 URL，可以通过使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/baseURI" target="_blank" rel="noopener noreferrer"><code>document.baseURI</code> (en-US)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 的 JS 脚本查询。如果文档不包含 <code>&lt;base&gt;</code> 元素，<code>baseURI</code> 默认为 <code>document.location.href</code>。</p><h4 id="_1-启动应用" tabindex="-1"><a class="header-anchor" href="#_1-启动应用" aria-hidden="true">#</a> 1.启动应用</h4><p>startApp</p><ol><li><p>调用<code>getWujieById</code>和<code>getOptionsById</code>从map结构中拿到子应用实例和子应用配置，如果刚启动应用则为null。然后调用<code>mergeOptions</code>合并配置项</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startApp</span><span class="token punctuation">(</span>startOptions<span class="token operator">:</span> startOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Function</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//在map结构中注册该子应用id 也就是子应用传入的name，</span>
  <span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token function">getWujieById</span><span class="token punctuation">(</span>startOptions<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从map结构中取出该子应用实例  首次为null</span>
  <span class="token keyword">const</span> cacheOptions <span class="token operator">=</span> <span class="token function">getOptionsById</span><span class="token punctuation">(</span>startOptions<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从map结构中取出该子应用的配置项  首次为null</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>startOptions<span class="token punctuation">,</span> cacheOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>如果<code>sandbox</code>存在也就是说已经创建过子应用实例了。</p></li><li><p>如果不存在则执行<code>new WuJie</code>创建沙箱环境。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> newSandbox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WuJie</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">,</span> url<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> degradeAttrs<span class="token punctuation">,</span> fiber<span class="token punctuation">,</span> degrade<span class="token punctuation">,</span> plugins<span class="token punctuation">,</span> lifecycles <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ol><h4 id="_2-创建沙箱环境" tabindex="-1"><a class="header-anchor" href="#_2-创建沙箱环境" aria-hidden="true">#</a> 2.创建沙箱环境</h4><p>①先解析子应用的路径。调用<code>iframeGenerator</code>创建iframe</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 创建目标地址的解析</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> urlElement<span class="token punctuation">,</span> appHostPath<span class="token punctuation">,</span> appRoutePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">appRouteParse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> mainHostPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inject<span class="token punctuation">;</span>
    <span class="token comment">// 创建iframe</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iframe <span class="token operator">=</span> <span class="token function">iframeGenerator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> mainHostPath<span class="token punctuation">,</span> appHostPath<span class="token punctuation">,</span> appRoutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>②创建iframe，</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">iframeGenerator</span><span class="token punctuation">(</span>  
  sandbox<span class="token operator">:</span> WuJie<span class="token punctuation">,</span>
  attrs<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mainHostPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  appHostPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  appRoutePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
           <span class="token keyword">const</span> iframe <span class="token operator">=</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;iframe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> attrsMerge <span class="token operator">=</span> <span class="token punctuation">{</span> src<span class="token operator">:</span> mainHostPath<span class="token punctuation">,</span> style<span class="token operator">:</span> <span class="token string">&quot;display: none&quot;</span><span class="token punctuation">,</span> <span class="token operator">...</span>attrs<span class="token punctuation">,</span> name<span class="token operator">:</span> sandbox<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token constant">WUJIE_DATA_FLAG</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">setAttrsToElement</span><span class="token punctuation">(</span>iframe<span class="token punctuation">,</span> attrsMerge<span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>③得到iframe的window并注入一些属性</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>iframeGenerator<span class="token punctuation">{</span>
   <span class="token keyword">const</span> iframeWindow <span class="token operator">=</span> iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">;</span>
  <span class="token comment">// 变量需要提前注入，在入口函数通过变量防止死循环</span>
  <span class="token function">patchIframeVariable</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">,</span> sandbox<span class="token punctuation">,</span> appHostPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">patchIframeVariable</span><span class="token punctuation">(</span>iframeWindow<span class="token operator">:</span> Window<span class="token punctuation">,</span> wujie<span class="token operator">:</span> WuJie<span class="token punctuation">,</span> appHostPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  iframeWindow<span class="token punctuation">.</span>__WUJIE <span class="token operator">=</span> wujie<span class="token punctuation">;</span>
  iframeWindow<span class="token punctuation">.</span>__WUJIE_PUBLIC_PATH__ <span class="token operator">=</span> appHostPath <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
  iframeWindow<span class="token punctuation">.</span>$wujie <span class="token operator">=</span> wujie<span class="token punctuation">.</span>provide<span class="token punctuation">;</span>
  iframeWindow<span class="token punctuation">.</span>__WUJIE_RAW_WINDOW__ <span class="token operator">=</span> iframeWindow<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>④为了防止运行主应用的js代码，给子应用带来很多副作用，用定时器去停止ifrm的widnow</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>iframeGenerator<span class="token punctuation">{</span>
  sandbox<span class="token punctuation">.</span>iframeReady <span class="token operator">=</span> <span class="token function">stopIframeLoading</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token keyword">return</span> iframe<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">stopIframeLoading</span><span class="token punctuation">(</span>iframeWindow<span class="token operator">:</span> Window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldDoc <span class="token operator">=</span> iframeWindow<span class="token punctuation">.</span>document<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> newDoc<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          newDoc <span class="token operator">=</span> iframeWindow<span class="token punctuation">.</span>document<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          newDoc <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// wait for document ready</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newDoc <span class="token operator">||</span> newDoc <span class="token operator">==</span> oldDoc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          iframeWindow<span class="token punctuation">.</span>stop <span class="token operator">?</span> iframeWindow<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> iframeWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">&quot;Stop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>⑤在停止了子iframe的window加载后，初始化iframe的dom</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>  sandbox<span class="token punctuation">.</span>iframeReady <span class="token operator">=</span> <span class="token function">stopIframeLoading</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">initIframeDom</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">,</span> sandbox<span class="token punctuation">,</span> mainHostPath<span class="token punctuation">,</span> appHostPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>⑥用全局window创建一个新的 HTML 文档，并拷贝一份，然后把这个拷贝的节点插入到iframe的文档中。如果<code>iframe.documentElement</code>存在就用新的替代旧的</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">initIframeDom</span><span class="token punctuation">(</span>iframeWindow<span class="token operator">:</span> Window<span class="token punctuation">,</span> wujie<span class="token operator">:</span> WuJie<span class="token punctuation">,</span> mainHostPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> appHostPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> iframeDocument <span class="token operator">=</span> iframeWindow<span class="token punctuation">.</span>document<span class="token punctuation">;</span>
  <span class="token keyword">const</span> newDoc <span class="token operator">=</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span><span class="token function">createHTMLDocument</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> newDocumentElement <span class="token operator">=</span> iframeDocument<span class="token punctuation">.</span><span class="token function">importNode</span><span class="token punctuation">(</span>newDoc<span class="token punctuation">.</span>documentElement<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  iframeDocument<span class="token punctuation">.</span>documentElement
    <span class="token operator">?</span> iframeDocument<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDocumentElement<span class="token punctuation">,</span> iframeDocument<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span>
    <span class="token operator">:</span> iframeDocument<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newDocumentElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>⑦注入文档对象的查询和创建元素方法</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>  iframeWindow<span class="token punctuation">.</span>__WUJIE_RAW_DOCUMENT_HEAD__ <span class="token operator">=</span> iframeDocument<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
  iframeWindow<span class="token punctuation">.</span>__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__ <span class="token operator">=</span> iframeWindow<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>querySelector<span class="token punctuation">;</span>
  iframeWindow<span class="token punctuation">.</span>__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__ <span class="token operator">=</span> iframeWindow<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>querySelectorAll<span class="token punctuation">;</span>
  iframeWindow<span class="token punctuation">.</span>__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__ <span class="token operator">=</span> iframeWindow<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>createElement<span class="token punctuation">;</span>
  iframeWindow<span class="token punctuation">.</span>__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__ <span class="token operator">=</span> iframeWindow<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>createTextNode<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>⑧初始化base标签，将base标签url设置为子应用的url，</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code> <span class="token function">initBase</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">,</span> wujie<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initBase</span><span class="token punctuation">(</span>iframeWindow<span class="token operator">:</span> Window<span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> iframeDocument <span class="token operator">=</span> iframeWindow<span class="token punctuation">.</span>document<span class="token punctuation">;</span>
  <span class="token keyword">const</span> baseElement <span class="token operator">=</span> iframeDocument<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;base&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> iframeUrlElement <span class="token operator">=</span> <span class="token function">anchorElementGenerator</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> appUrlElement <span class="token operator">=</span> <span class="token function">anchorElementGenerator</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  baseElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">,</span> appUrlElement<span class="token punctuation">.</span>protocol <span class="token operator">+</span> <span class="token string">&quot;//&quot;</span> <span class="token operator">+</span> appUrlElement<span class="token punctuation">.</span>host <span class="token operator">+</span> iframeUrlElement<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  iframeDocument<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>baseElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>⑨重写History中的api<code>pushState</code>和<code>replaceState</code>保证iframe的url变化同步到Window中</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">patchIframeHistory</span><span class="token punctuation">(</span>iframeWindow<span class="token operator">:</span> Window<span class="token punctuation">,</span> appHostPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> mainHostPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> history <span class="token operator">=</span> iframeWindow<span class="token punctuation">.</span>history<span class="token punctuation">;</span>
  <span class="token keyword">const</span> rawHistoryPushState <span class="token operator">=</span> history<span class="token punctuation">.</span>pushState<span class="token punctuation">;</span>
  <span class="token keyword">const</span> rawHistoryReplaceState <span class="token operator">=</span> history<span class="token punctuation">.</span>replaceState<span class="token punctuation">;</span>
  history<span class="token punctuation">.</span><span class="token function-variable function">pushState</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> url<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> baseUrl <span class="token operator">=</span>
      mainHostPath <span class="token operator">+</span> iframeWindow<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname <span class="token operator">+</span> iframeWindow<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search <span class="token operator">+</span> iframeWindow<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
    <span class="token keyword">const</span> mainUrl <span class="token operator">=</span> <span class="token function">getAbsolutePath</span><span class="token punctuation">(</span>url<span class="token operator">?.</span><span class="token function">replace</span><span class="token punctuation">(</span>appHostPath<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> baseUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ignoreFlag <span class="token operator">=</span> url <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

    <span class="token function">rawHistoryPushState</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span> data<span class="token punctuation">,</span> title<span class="token punctuation">,</span> ignoreFlag <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> mainUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoreFlag<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token function">updateBase</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">,</span> appHostPath<span class="token punctuation">,</span> mainHostPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">syncUrlToWindow</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  history<span class="token punctuation">.</span><span class="token function-variable function">replaceState</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> url<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> baseUrl <span class="token operator">=</span>
      mainHostPath <span class="token operator">+</span> iframeWindow<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname <span class="token operator">+</span> iframeWindow<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search <span class="token operator">+</span> iframeWindow<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
    <span class="token keyword">const</span> mainUrl <span class="token operator">=</span> <span class="token function">getAbsolutePath</span><span class="token punctuation">(</span>url<span class="token operator">?.</span><span class="token function">replace</span><span class="token punctuation">(</span>appHostPath<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> baseUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ignoreFlag <span class="token operator">=</span> url <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

    <span class="token function">rawHistoryReplaceState</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span> data<span class="token punctuation">,</span> title<span class="token punctuation">,</span> ignoreFlag <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> mainUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoreFlag<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token function">updateBase</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">,</span> appHostPath<span class="token punctuation">,</span> mainHostPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">syncUrlToWindow</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="模块联邦module-federation" tabindex="-1"><a class="header-anchor" href="#模块联邦module-federation" aria-hidden="true">#</a> 模块联邦Module Federation</h2><p>多个独立的构建可以组成一个应用程序，这些独立的构建之间不应该存在依赖关系，因此可以单独开发和部署它们。这通常被称作微前端，但并不仅限于此。比如a应用如果想使用b应用中form的组件，通过模块联邦可以直接在a中进行import(&#39;b/form&#39;)非常的方便。</p><p>模块联邦优点：可以单独部署对模块的更改，而不需要重新部署所有应用程序。应用程序自动使用组件库的最新版本。（例如将公共依赖发布到npm，其他依赖的项目安装即可，但是存在问题，如果依赖升级，所有项目都需要重新安装依赖。而模块联邦中，项目利用CDN共享，我们永远访问的是最新的代码。）</p><h3 id="modulefederationplugin-high-level" tabindex="-1"><a class="header-anchor" href="#modulefederationplugin-high-level" aria-hidden="true">#</a> ModuleFederationPlugin (high level)</h3><p><a href="https://www.webpackjs.com/plugins/module-federation-plugin/" target="_blank" rel="noopener noreferrer">文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 模块联邦名字，提供给其他模块使用</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;app1&#39;</span><span class="token punctuation">,</span>
      <span class="token comment">// 提供给外部访问的资源入口</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;App1RemoteEntry.js&#39;</span><span class="token punctuation">,</span>
      <span class="token comment">// 引用的外部资源列表</span>
      <span class="token literal-property property">remotes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         *  App2 引用其他应用模块的资源别名
         *  app2 是 APP2 的模块联邦名字
         *  http://localhost:3001 是 APP2 运行的地址
         *  App2RemoteEntry.js 是 APP2 提供的外部访问的资源名字
         *  可以访问到 APP2 通过 exposes 暴露给外部的资源
         */</span>
        <span class="token literal-property property">App2</span><span class="token operator">:</span> <span class="token string">&#39;app2@http://localhost:3001/App2RemoteEntry.js&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 暴露给外部的资源列表</span>
      <span class="token literal-property property">exposes</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 共享模块，pinia</span>
      <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="基本概念" tabindex="-1"><a class="header-anchor" href="#基本概念" aria-hidden="true">#</a> 基本概念</h3><ol><li>本地模块：本地模块就是我们当前开发的代码模块。</li><li>远程模块：不属于当前开发代码，远程模块在运行时加载。</li><li>容器：就是构建的项目。每个构建的充当一个容器，也可以将其他构建作为容器。通过这种方式每个构建都能从对应容器中加载暴露的模块。</li><li>一个被引用得容器或称为remote，引用者被称为host，remote暴露模块给host，host则可以使用这些暴露的模块，这些模块被称为remote模块。</li></ol><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/Notes/FrontEndEngineering/%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8%E7%9A%84%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86.html" class="" aria-label="包管理器的相关知识"><!--[--><!--]--> 包管理器的相关知识 <!--[--><!--]--></a></span><span class="next"><a href="/Notes/FrontEndEngineering/%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA.html" class="" aria-label="项目初始化"><!--[--><!--]--> 项目初始化 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><div class="container" data-v-25ddea2d><span class="des" data-v-25ddea2d>暂无记录 <span class="arrow down" data-v-25ddea2d></span></span><div class="rencent-content-container" data-v-25ddea2d><!--[--><!--]--></div></div><!--]--></div>
    <script type="module" src="/assets/app-c7df0862.js" defer></script>
  </body>
</html>
