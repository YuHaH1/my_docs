import{_ as s,M as a,p as t,q as p,N as o,a1 as e}from"./framework-5866ffd3.js";const c={},l=e(`<h1 id="jsä¸­é‡åˆ°çš„é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#jsä¸­é‡åˆ°çš„é—®é¢˜" aria-hidden="true">#</a> jsä¸­é‡åˆ°çš„é—®é¢˜</h1><h2 id="_1-å­—ç¬¦ä¸²è¡¨æƒ…é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_1-å­—ç¬¦ä¸²è¡¨æƒ…é—®é¢˜" aria-hidden="true">#</a> 1.å­—ç¬¦ä¸²è¡¨æƒ…é—®é¢˜</h2><p>åœ¨æŠ–éŸ³é‡åˆ°çš„ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">&#39;ğŸ˜ŠğŸ˜”ğŸ†’ğŸ˜€&#39;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
è¾“å‡ºç»“æœæ˜¯
<span class="token number">8</span>
ï¿½
ï¿½ï¿½
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯ä¸ªæ–‡å­—éƒ½å¯¹åº”ä¸€ä¸ªæ•°å­—ï¼Œè¡¨æƒ…ä¹Ÿæ˜¯æ–‡å­—æ‰€ä»¥ä¹Ÿæ˜¯å¦‚æ­¤ã€‚jsç¼–ç ä½¿ç”¨<code>utf-16</code>æ‰€ä»¥æ¯ä¸ªå­—ç¬¦ä¸²å 16ä½ä¹Ÿå°±æ˜¯ä¸¤ä¸ªå­—èŠ‚ã€‚èƒ½å­˜çš„èŒƒå›´æ˜¯<code>2^16=0-65535</code>ã€‚</p><p>è€Œå¯¹äºä¸€äº›æ–‡å­—å’Œè¡¨æƒ…ï¼Œä»–ä»¬çš„å­˜å‚¨ç©ºé—´è¶…è¿‡65535ä¸ªå­—èŠ‚èŒƒå›´ï¼Œé‡åˆ°å­˜å‚¨ä¸ä¸‹çš„æƒ…å†µå°±éœ€è¦ç”¨ä¸¤ä¸ª16ä½å­˜å‚¨ä¹Ÿå°±æ˜¯2^32çš„èŒƒå›´ã€‚</p><p>è€Œä¸€ä¸ª16ä½çš„å­˜å‚¨å•ä½æˆä¸º<strong>ç å…ƒ</strong><code>Code Unit</code>ï¼Œè€Œä¸€ä¸ªæ–‡å­—å¯èƒ½å 1ä¸ª16ä½ä¹Ÿæœ‰å¯èƒ½2ä¸ª16ä½ï¼Œè¿™ä¸ªç§°ä¸º<strong>ç ç‚¹</strong><code>Code Point</code>ï¼Œå› æ­¤ä¸€ä¸ªå®Œæ•´å­—ç¬¦æ˜¯<strong>ç ç‚¹</strong></p><p>ä¸ºä»€ä¹ˆè¾“å‡ºç»“æœæ˜¯ä¸Šé¢çš„æƒ…å†µï¼Ÿç°åœ¨æˆ‘ä»¬çŸ¥é“æ˜¯å› ä¸ºä¸Šé¢è®¿é—®çš„éƒ½æ˜¯<strong>ç å…ƒ</strong>ï¼Œè€Œä¸Šé¢è¡¨æƒ…çš„ç ç‚¹éƒ½å äº†2ä¸ª16ä½ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">&quot;ğŸ¦ŒağŸ˜€ğŸ˜ŠğŸŸ&quot;</span>
<span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">pointLength</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> length <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> point <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        i <span class="token operator">+=</span> point <span class="token operator">&gt;</span> <span class="token number">65535</span><span class="token operator">?</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">1</span>
        length<span class="token operator">++</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> length
<span class="token punctuation">}</span>
<span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">pointAt</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> point <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°†ç ç‚¹è½¬æˆå­—ç¬¦</span>
            res <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">fromCodePoint</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        i <span class="token operator">+=</span> point <span class="token operator">&gt;</span> <span class="token number">65535</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span>
        current<span class="token operator">++</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
<span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">slice</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        res <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pointAt</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">pointLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">pointAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
è¾“å‡ºç»“æœ
<span class="token number">5</span>
a
ğŸ¦ŒağŸ˜€
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-å¦‚ä½•è®°å½•ç”¨æˆ·ä¿¡æ¯-canvas" tabindex="-1"><a class="header-anchor" href="#_2-å¦‚ä½•è®°å½•ç”¨æˆ·ä¿¡æ¯-canvas" aria-hidden="true">#</a> 2.å¦‚ä½•è®°å½•ç”¨æˆ·ä¿¡æ¯-canvas</h2><p>cookieå­˜åœ¨è¢«ç¦æ­¢æˆ–è€…è·¨åŸŸæ— æ³•è®¿é—®çš„é—®é¢˜</p><p>canvasä¼šè·å–è®¾å¤‡ã€æ“ä½œç³»ç»Ÿã€æµè§ˆå™¨å”¯ä¸€æ ‡è¯†è¿›è¡Œä¸‰åˆä¸€</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">uuid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;2d&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> txt <span class="token operator">=</span> <span class="token string">&#39;test&#39;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>txt<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token comment">//è¿™ä¸ªbase64å°±å­˜æ”¾è¿™ä¸‰åˆä¸€æ ‡è¯†ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨md5è¿›è¡Œå‹ç¼©æˆ–è€…crypto</span>
    <span class="token keyword">return</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-ajaxå’Œfetchå–æ¶ˆè¯·æ±‚çš„æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_3-ajaxå’Œfetchå–æ¶ˆè¯·æ±‚çš„æ–¹å¼" aria-hidden="true">#</a> 3.Ajaxå’Œfetchå–æ¶ˆè¯·æ±‚çš„æ–¹å¼</h2><p>ä¸ºä»€ä¹ˆéœ€è¦å–æ¶ˆè¯·æ±‚ï¼Ÿæœ‰æ—¶å€™å¯¹äºä¸€ä¸ªæ¥å£çŸ­æ—¶é—´çš„é‡å¤è°ƒç”¨è¯¥æ¥å£æ˜¯æ²¡æ„ä¹‰çš„ã€‚</p><h3 id="_3-1ã€fetchå–æ¶ˆ" tabindex="-1"><a class="header-anchor" href="#_3-1ã€fetchå–æ¶ˆ" aria-hidden="true">#</a> 3.1ã€fetchå–æ¶ˆ</h3><p><code>AbortControllerã€‚signal</code>å±æ€§è·å–åˆ°å®ƒçš„å…³è”å¯¹è±¡çš„å¼•ç”¨ï¼Œå½“fetchè¯·æ±‚åˆå§‹åŒ–æ—¶ï¼Œå°†ä¿¡å·ä½œä¸ºé€‰é¡¹ä¼ å…¥ï¼Œç„¶åé€šè¿‡ <code>controller.abort();</code>å°±å¯ä»¥ç»ˆæ­¢è¯¥è¯·æ±‚</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> signal <span class="token operator">=</span> controller<span class="token punctuation">.</span>signal<span class="token punctuation">;</span>

<span class="token keyword">const</span> downloadBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.download&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> abortBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.abort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

downloadBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> fetchVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>

abortBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Download aborted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">fetchVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> signal <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Download complete&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Download error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>err<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2ã€ajaxå–æ¶ˆ" tabindex="-1"><a class="header-anchor" href="#_3-2ã€ajaxå–æ¶ˆ" aria-hidden="true">#</a> 3.2ã€Ajaxå–æ¶ˆ</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    method <span class="token operator">=</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://developer.mozilla.org/&quot;</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">OH_NOES_WE_NEED_TO_CANCEL_RIGHT_NOW_OR_ELSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  xhr<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4ã€é¡µé¢æ›´æ–°è‡ªåŠ¨åˆ·æ–°é¡µé¢" tabindex="-1"><a class="header-anchor" href="#_4ã€é¡µé¢æ›´æ–°è‡ªåŠ¨åˆ·æ–°é¡µé¢" aria-hidden="true">#</a> 4ã€é¡µé¢æ›´æ–°è‡ªåŠ¨åˆ·æ–°é¡µé¢</h2><p>å¦‚æœç”¨æˆ·é•¿æ—¶é—´è¯¯æ“ä½œï¼Œé¡µé¢å¯èƒ½ä¼šæ›´æ–°ï¼Œå¯ä»¥æç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢</p><p>æ€è·¯ï¼Œæ¯”å¯¹scriptçš„srcé‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè§‚å¯Ÿåˆ°é¡µé¢å˜åŒ–é‡è½½é¡µé¢ã€‚å‰ç«¯é€šè¿‡è½®è¯¢å»åšè¿™é‡Œä½¿ç”¨çš„ã€‚</p><p>é€šè¿‡è®¿é—®å™¨æš‚åœå’Œå¯åŠ¨å¯¹é¡µé¢çš„è§‚å¯Ÿã€‚</p><p>é€šè¿‡ä»£ç†å®ç°å•ä¾‹æ¨¡å¼ã€‚</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> IOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../types&#39;</span>
<span class="token keyword">declare</span> <span class="token keyword">const</span> <span class="token constant">VERSION</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token keyword">const</span> regSrc <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;script.*src=[&quot;&#39;](?&lt;src&gt;[^&quot;&#39;]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span>
<span class="token keyword">class</span> <span class="token class-name">Updater</span> <span class="token punctuation">{</span>
  oldSrcList<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  version<span class="token operator">:</span> <span class="token builtin">string</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span>
  cb<span class="token operator">:</span> IOptions<span class="token punctuation">[</span><span class="token string">&#39;cb&#39;</span><span class="token punctuation">]</span>
  time<span class="token operator">:</span> <span class="token builtin">number</span>
  needUpdate<span class="token operator">:</span> <span class="token builtin">boolean</span>
  lastTime<span class="token operator">:</span> <span class="token builtin">number</span>
  #updateEvent<span class="token operator">:</span> Event <span class="token operator">|</span> <span class="token keyword">null</span>
  #stop<span class="token operator">:</span> <span class="token builtin">boolean</span>
  #id<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>options<span class="token operator">:</span> IOptions <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#id <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> options<span class="token operator">?.</span>url <span class="token operator">||</span> <span class="token string">&#39;/&#39;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#updateEvent <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#stop <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token constant">VERSION</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> options<span class="token operator">?.</span>cb
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>oldSrcList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> options<span class="token operator">?.</span>time <span class="token operator">||</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#stop
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">stop</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">&#39;boolean&#39;</span><span class="token punctuation">)</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;if you want to stop check please set stop with boolean&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#stop <span class="token operator">=</span> value
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#stop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cancelIdleCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#id<span class="token punctuation">)</span>
      window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;auto-update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleAutoUpdate<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆå§‹åŒ–äº‹ä»¶</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">watch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#id <span class="token operator">=</span> <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime <span class="token operator">=</span> now
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleAutoUpdate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">initEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#updateEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&#39;auto-update&#39;</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;auto-update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleAutoUpdate<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ‹‰å–htmlå†…å®¹</span>
  fetchFileContent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// é˜²æ­¢ç¼“å­˜åŠ ä¸Šæ—¶é—´æˆ³</span>
      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?timestamp=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">checkChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span>res<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldSrcList<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token operator">===</span> res<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>oldSrcList <span class="token operator">=</span> res
      <span class="token keyword">this</span><span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">getScriptSrc</span> <span class="token operator">=</span> <span class="token punctuation">(</span>content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regSrc<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldSrcList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token comment">// é¦–æ¬¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>oldSrcList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>res<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkChange</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;don\\&#39;t find script src&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  checkUpdate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>needUpdate<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#updateEvent <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#updateEvent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–index.htmlçš„å­—ç¬¦ä¸²</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchFileContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// è§£æå­—ç¬¦ä¸²å¹¶ä¿å­˜</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getScriptSrc</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// è½®è¯¢</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// å•ä¾‹</span>
<span class="token keyword">let</span> instance<span class="token operator">:</span> Updater <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> proxyUpdater <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>Updater<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">construct</span><span class="token punctuation">(</span>Target<span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> arg <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">)</span>
      instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Target</span><span class="token punctuation">(</span>arg <span class="token keyword">as</span> IOptions<span class="token punctuation">)</span>
    <span class="token keyword">return</span> instance
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> proxyUpdater

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,26);function i(u,k){const n=a("CommentService");return t(),p("div",null,[l,o(n)])}const d=s(c,[["render",i],["__file","jsä¸­é‡åˆ°çš„é—®é¢˜.html.vue"]]);export{d as default};
